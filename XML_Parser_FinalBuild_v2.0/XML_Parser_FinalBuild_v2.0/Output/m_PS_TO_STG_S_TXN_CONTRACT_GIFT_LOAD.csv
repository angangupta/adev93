Mapping Index,Target Index,Mapping Name,Source Instance Type,Source Instance,Source Location,Source Field,Target Instance Type,Target Instance,Target Field,Port Type,Expression,Source Override SQL,Pre Post SQL,Joiner Extract,Filter Expression
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CREATE_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CREATE_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ROW_HASH,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ROW_HASH,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,FEATURE_TRANSACTION_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,INFINIUM_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TARIFF,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TARIFF,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TAX_DISTRICT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TAX_DISTRICT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GEO_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GEO_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,WIRE_CENTER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,WIRE_CENTER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,IN_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,IN_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CONTRACT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,VALUE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,VALUE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_SEND_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,USI,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CA_GENERATED,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_ENVIRONMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,SERVICE_TYPE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,SERVICE_TYPE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACCOUNT_SEGMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CREATE_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,CREATE_DATE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_COMMON_FIELDS,ROW_HASH,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_ID,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_COMMON_FIELDS,ITEM_SEQUENCE_NUMBER,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_KEY,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,PRD_CATLG_KEY,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_COMMON_FIELDS,FEATURE_TRANSACTION_ID,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_GL_CODE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,INFINIUM_GL_CODE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_ID,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,CONTRACT_ID,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Expression,EXP_GENERATE_COMMON_FIELDS,ACTIVITY_FLAG,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_SEND_DATE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TARIFF,Expression,EXP_GENERATE_COMMON_FIELDS,TARIFF,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TAX_DISTRICT,Expression,EXP_GENERATE_COMMON_FIELDS,TAX_DISTRICT,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_ENVIRONMENT,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GEO_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,GEO_CODE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_COMMON_FIELDS,USI,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CA_GENERATED,Expression,EXP_GENERATE_COMMON_FIELDS,CA_GENERATED,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_COMMON_FIELDS,SERVICE_TYPE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_COMMON_FIELDS,ACCOUNT_SEGMENT,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,WIRE_CENTER,Expression,EXP_GENERATE_COMMON_FIELDS,WIRE_CENTER,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,IN_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,IN_DATE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,VALUE,Expression,EXP_GENERATE_COMMON_FIELDS,VALUE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CONTRACT_ID3,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,i_CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CREATE_DATE,Router,RTR_CHECK_ERROR,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_LAST_UPDATED_DATE,Router,RTR_CHECK_ERROR,LAST_UPDATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_BY,Router,RTR_CHECK_ERROR,CREATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_UPDATED_BY,Router,RTR_CHECK_ERROR,UPDATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,PRD_CATLG_KEY,Router,RTR_CHECK_ERROR,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_CODE,Router,RTR_CHECK_ERROR,o_ERROR_CODE,OUTPUT,"REG_REPLACE(v_ERROR_CODE,'^\W*','')",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_SOURCE_COLUMN,Router,RTR_CHECK_ERROR,o_SOURCE_COLUMN,OUTPUT,"REG_REPLACE(v_SOURCE_COLUMN,'^\W*','')",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_REQUIRED_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_REQUIRED_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY) OR 
ISNULL(PRD_CATLG_KEY),$$ERR_REPROCES_REQURD_ACTV_FLG,$$ERR_REPROCES_REQURD_FLG)",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_COMPLETE_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_COMPLETE_FLAG,OUTPUT,$$ERR_REPROCES_COMPLT_FLG,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,INFINIUM_GL_CODE,Router,RTR_CHECK_ERROR,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_FLAG,Router,RTR_CHECK_ERROR,o_ERROR_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY)OR 
ISNULL(PRD_CATLG_KEY) OR 
ISNULL(ITEM_SEQUENCE_NUMBER) OR ISNULL(FEATURE_TRANSACTION_ID) OR ISNULL(INFINIUM_GL_CODE) OR INFINIUM_GL_CODE='0000000000000000000000','E','S')",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,FEATURE_TRANSACTION_ID,Router,RTR_CHECK_ERROR,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_GL_CODE,Router,RTR_CHECK_ERROR,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TARIFF,Router,RTR_CHECK_ERROR,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TAX_DISTRICT,Router,RTR_CHECK_ERROR,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GEO_CODE,Router,RTR_CHECK_ERROR,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,WIRE_CENTER,Router,RTR_CHECK_ERROR,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,IN_DATE,Router,RTR_CHECK_ERROR,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,USI,Router,RTR_CHECK_ERROR,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ETL_CYCLE_ID,Router,RTR_CHECK_ERROR,ETL_CYCLE_ID,OUTPUT,$$ETL_CYCLE_ID,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ROW_HASH,Router,RTR_CHECK_ERROR,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_DATE,Router,RTR_CHECK_ERROR,CREATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ITEM_SEQUENCE_NUMBER,Router,RTR_CHECK_ERROR,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_KEY,Router,RTR_CHECK_ERROR,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_ID,Router,RTR_CHECK_ERROR,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CONTRACT_ID,Router,RTR_CHECK_ERROR,CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACTIVITY_FLAG,Router,RTR_CHECK_ERROR,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_SEND_DATE,Router,RTR_CHECK_ERROR,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,VALUE,Router,RTR_CHECK_ERROR,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CA_GENERATED,Router,RTR_CHECK_ERROR,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_ENVIRONMENT,Router,RTR_CHECK_ERROR,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,SERVICE_TYPE,Router,RTR_CHECK_ERROR,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACCOUNT_SEGMENT,Router,RTR_CHECK_ERROR,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_ID,Router,RTR_CHECK_ERROR,DPI_CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_HASH,lkp_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EFFEC_STRT_DT,Expression,EXP_GENERATE_HASH,lkp_EFFEC_STRT_DT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_HASH,lkp_ROW_HASH,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_HASH,lkp_FEATURE_TRANSACTION_ID,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FIRST_BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_TGT_FIRST_BILL_DATE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_HASH,lkp_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_HASH,lkp_DPI_ENVIRONMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_HASH,lkp_SERVICE_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_HASH,lkp_ACCOUNT_SEGMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EVENT_TYPE,Expression,EXP_GENERATE_HASH,lkp_EVENT_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_HASH,lkp_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_HASH,lkp_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Expression,EXP_GENERATE_HASH,DPI_CONTRACT_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Expression,EXP_GENERATE_HASH,PRD_CATLG_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_BY3,Expression,EXP_GENERATE_HASH,CREATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Expression,EXP_GENERATE_HASH,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_DATE3,Expression,EXP_GENERATE_HASH,CREATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,LAST_UPDATED_DATE3,Expression,EXP_GENERATE_HASH,LAST_UPDATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,UPDATED_BY3,Expression,EXP_GENERATE_HASH,UPDATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CA_GENERATED3,Expression,EXP_GENERATE_HASH,CA_GENERATED1,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,IN_DATE3,Expression,EXP_GENERATE_HASH,IN_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Expression,EXP_GENERATE_HASH,USI,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_ID3,Expression,EXP_GENERATE_HASH,GIFT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ETL_CYCLE_ID3,Expression,EXP_GENERATE_HASH,ETL_CYCLE_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,FEATURE_TRANSACTION_ID3,Expression,EXP_GENERATE_HASH,FEATURE_TRANSACTION_ID,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_GL_CODE3,Expression,EXP_GENERATE_HASH,DPI_GL_CODE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,INFINIUM_GL_CODE3,Expression,EXP_GENERATE_HASH,INFINIUM_GL_CODE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TARIFF3,Expression,EXP_GENERATE_HASH,TARIFF,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TAX_DISTRICT3,Expression,EXP_GENERATE_HASH,TAX_DISTRICT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GEO_CODE3,Expression,EXP_GENERATE_HASH,GEO_CODE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,WIRE_CENTER3,Expression,EXP_GENERATE_HASH,WIRE_CENTER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACTIVITY_FLAG3,Expression,EXP_GENERATE_HASH,ACTIVITY_FLAG,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACCOUNT_SEGMENT3,Expression,EXP_GENERATE_HASH,ACCOUNT_SEGMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_SEND_DATE3,Expression,EXP_GENERATE_HASH,GIFT_SEND_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_ENVIRONMENT3,Expression,EXP_GENERATE_HASH,DPI_ENVIRONMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,SERVICE_TYPE3,Expression,EXP_GENERATE_HASH,SERVICE_TYPE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,VALUE3,Expression,EXP_GENERATE_HASH,VALUE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATE_DATE3,Expression,EXP_GENERATE_HASH,CREATE_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,,BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_SRC_FIRST_BILL_DATE,,,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,FEATURE_TRANSACTION_ID3,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,DPI_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,INFINIUM_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,INFINIUM_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,lkp_FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_ID,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACTIVITY_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_SEND_DATE,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TAX_DISTRICT,Router,RTR_INSERT_UPSERT_IGNORE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,VALUE,Router,RTR_INSERT_UPSERT_IGNORE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,lkp_ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EFFEC_STRT_DT,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EFFEC_STRT_DT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_ROW_HASH,Router,RTR_INSERT_UPSERT_IGNORE,o_ROW_HASH,OUTPUT,v_ROW_HASH,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INS_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INS_FLAG,OUTPUT,v_INS_FLAG,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_UPD_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_UPD_FLAG,OUTPUT,v_UPD_FLAG,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,UPDATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,LAST_UPDATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ETL_CYCLE_ID,Router,RTR_INSERT_UPSERT_IGNORE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INPUT_TYPE_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INPUT_TYPE_FLAG,OUTPUT,"DECODE(1,
v_INS_FLAG='I' and ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'C', --ONLY CAPTURE EVENT
v_INS_FLAG='I' and NOT ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'R', --COMBINED EVENT
v_UPD_FLAG='U' ,'U' -- ONLY RELEASE EVENT/ WRITE-OFF/ DISQUALIFIED EVENT
)

",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EVENT_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EVENT_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CA_GENERATED1,Router,RTR_INSERT_UPSERT_IGNORE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_ENVIRONMENT,Router,RTR_INSERT_UPSERT_IGNORE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,SERVICE_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACCOUNT_SEGMENT,Router,RTR_INSERT_UPSERT_IGNORE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATE_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TARIFF,Router,RTR_INSERT_UPSERT_IGNORE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GEO_CODE,Router,RTR_INSERT_UPSERT_IGNORE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,WIRE_CENTER,Router,RTR_INSERT_UPSERT_IGNORE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,IN_DATE,Router,RTR_INSERT_UPSERT_IGNORE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_FIRST_BILL_DATE,Router,RTR_INSERT_UPSERT_IGNORE,FIRST_BILL_DATE,OUTPUT,v_FIRST_BILL_DATE,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,USI,Router,RTR_INSERT_UPSERT_IGNORE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_USI,Router,RTR_INSERT_UPSERT_IGNORE,lkp_USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_INPUT_TYPE_FLAG5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,o_INPUT_TYPE_FLAG,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CA_GENERATED5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,CA_GENERATED,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_ID5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,GIFT_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,PRD_CATLG_KEY5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,PRD_CATLG_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ITEM_SEQUENCE_NUMBER5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_SEND_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,GIFT_SEND_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,VALUE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,VALU1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATE_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,CREATE_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_ROW_HASH5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,ROW_HASH,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,CREATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,LAST_UPDATED_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,LAST_UPDATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_BY5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,CREATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,UPDATED_BY5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,UPDATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_ENVIRONMENT5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,DPI_ENVIRONMENT,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,SERVICE_TYPE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,SERVICE_TYPE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ACCOUNT_SEGMENT5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,ACCOUNT_SEGMENT,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ETL_CYCLE_ID5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,ETL_CYCLE_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FEATURE_TRANSACTION_ID35,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,FEATURE_TRANSACTION_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_GL_CODE35,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,DPI_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,INFINIUM_GL_CODE35,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,INFINIUM_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TARIFF5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,TARIFF1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TAX_DISTRICT5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,TAX_DISTRICT1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GEO_CODE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,GEO_CODE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,WIRE_CENTER5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,WIRE_CENTER1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,IN_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,IN_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FIRST_BILL_DATE5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,FIRST_BILL_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,USI5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,USI,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_CONTRACT_KEY5,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,DPI_CONTRACT_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' ,TRUE,FALSE)"
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,ACTIVITY_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,ACTIVITY_FLAG,OUTPUT,'B',,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,GIFT_SEND_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,VALU1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,o_EFFEC_END_DT,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,EFFEC_END_DT,OUTPUT,TRUNC($$EFFEC_END_DT),,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,o_CURRENT_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,CURRENT_FLAG,OUTPUT,"$$RECORD_ACTV_FLG
",,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,CREATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,LAST_UPDATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,CREATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,UPDATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,ETL_CYCLE_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,ROW_HASH,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,FEATURE_TRANSACTION_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,DPI_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,INFINIUM_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,TARIFF1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,DPI_ENVIRONMENT,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,SERVICE_TYPE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,ACCOUNT_SEGMENT,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,CREATE_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,o_EFFEC_STRT_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,EFFEC_STRT_DT,OUTPUT,TRUNC(SYSDATE),,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,TAX_DISTRICT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,GEO_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,WIRE_CENTER1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,IN_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,FIRST_BILL_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,FIRST_BILL_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,DPI_CONTRACT_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,USI,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,EVENT_TYPE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,EVENT_TYPE,OUTPUT,'RELEASE',,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,PROCESS_CYCLE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,PROCESS_CYCLE,OUTPUT,$$ETL_CYCLE_ID,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,CA_GENERATED,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,PRD_CATLG_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,ITEM_SEQUENCE_NUMBER,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,1,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_RELEASE,,GIFT_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_RELEASE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CREATE_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CREATE_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ROW_HASH,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ROW_HASH,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,FEATURE_TRANSACTION_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,INFINIUM_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TARIFF,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TARIFF,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TAX_DISTRICT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TAX_DISTRICT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GEO_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GEO_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,WIRE_CENTER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,WIRE_CENTER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,IN_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,IN_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CONTRACT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,VALUE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,VALUE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_SEND_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,USI,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CA_GENERATED,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_ENVIRONMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,SERVICE_TYPE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,SERVICE_TYPE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACCOUNT_SEGMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CREATE_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,CREATE_DATE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_COMMON_FIELDS,ROW_HASH,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_ID,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_COMMON_FIELDS,ITEM_SEQUENCE_NUMBER,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_KEY,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,PRD_CATLG_KEY,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_COMMON_FIELDS,FEATURE_TRANSACTION_ID,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_GL_CODE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,INFINIUM_GL_CODE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_ID,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,CONTRACT_ID,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Expression,EXP_GENERATE_COMMON_FIELDS,ACTIVITY_FLAG,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_SEND_DATE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TARIFF,Expression,EXP_GENERATE_COMMON_FIELDS,TARIFF,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TAX_DISTRICT,Expression,EXP_GENERATE_COMMON_FIELDS,TAX_DISTRICT,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_ENVIRONMENT,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GEO_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,GEO_CODE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_COMMON_FIELDS,USI,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CA_GENERATED,Expression,EXP_GENERATE_COMMON_FIELDS,CA_GENERATED,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_COMMON_FIELDS,SERVICE_TYPE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_COMMON_FIELDS,ACCOUNT_SEGMENT,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,WIRE_CENTER,Expression,EXP_GENERATE_COMMON_FIELDS,WIRE_CENTER,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,IN_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,IN_DATE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,VALUE,Expression,EXP_GENERATE_COMMON_FIELDS,VALUE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CONTRACT_ID3,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,i_CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CREATE_DATE,Router,RTR_CHECK_ERROR,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_LAST_UPDATED_DATE,Router,RTR_CHECK_ERROR,LAST_UPDATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_BY,Router,RTR_CHECK_ERROR,CREATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_UPDATED_BY,Router,RTR_CHECK_ERROR,UPDATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,PRD_CATLG_KEY,Router,RTR_CHECK_ERROR,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_CODE,Router,RTR_CHECK_ERROR,o_ERROR_CODE,OUTPUT,"REG_REPLACE(v_ERROR_CODE,'^\W*','')",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_SOURCE_COLUMN,Router,RTR_CHECK_ERROR,o_SOURCE_COLUMN,OUTPUT,"REG_REPLACE(v_SOURCE_COLUMN,'^\W*','')",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_REQUIRED_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_REQUIRED_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY) OR 
ISNULL(PRD_CATLG_KEY),$$ERR_REPROCES_REQURD_ACTV_FLG,$$ERR_REPROCES_REQURD_FLG)",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_COMPLETE_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_COMPLETE_FLAG,OUTPUT,$$ERR_REPROCES_COMPLT_FLG,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,INFINIUM_GL_CODE,Router,RTR_CHECK_ERROR,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_FLAG,Router,RTR_CHECK_ERROR,o_ERROR_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY)OR 
ISNULL(PRD_CATLG_KEY) OR 
ISNULL(ITEM_SEQUENCE_NUMBER) OR ISNULL(FEATURE_TRANSACTION_ID) OR ISNULL(INFINIUM_GL_CODE) OR INFINIUM_GL_CODE='0000000000000000000000','E','S')",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,FEATURE_TRANSACTION_ID,Router,RTR_CHECK_ERROR,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_GL_CODE,Router,RTR_CHECK_ERROR,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TARIFF,Router,RTR_CHECK_ERROR,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TAX_DISTRICT,Router,RTR_CHECK_ERROR,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GEO_CODE,Router,RTR_CHECK_ERROR,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,WIRE_CENTER,Router,RTR_CHECK_ERROR,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,IN_DATE,Router,RTR_CHECK_ERROR,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,USI,Router,RTR_CHECK_ERROR,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ETL_CYCLE_ID,Router,RTR_CHECK_ERROR,ETL_CYCLE_ID,OUTPUT,$$ETL_CYCLE_ID,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ROW_HASH,Router,RTR_CHECK_ERROR,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_DATE,Router,RTR_CHECK_ERROR,CREATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ITEM_SEQUENCE_NUMBER,Router,RTR_CHECK_ERROR,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_KEY,Router,RTR_CHECK_ERROR,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_ID,Router,RTR_CHECK_ERROR,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CONTRACT_ID,Router,RTR_CHECK_ERROR,CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACTIVITY_FLAG,Router,RTR_CHECK_ERROR,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_SEND_DATE,Router,RTR_CHECK_ERROR,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,VALUE,Router,RTR_CHECK_ERROR,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CA_GENERATED,Router,RTR_CHECK_ERROR,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_ENVIRONMENT,Router,RTR_CHECK_ERROR,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,SERVICE_TYPE,Router,RTR_CHECK_ERROR,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACCOUNT_SEGMENT,Router,RTR_CHECK_ERROR,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_ID,Router,RTR_CHECK_ERROR,DPI_CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_HASH,lkp_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EFFEC_STRT_DT,Expression,EXP_GENERATE_HASH,lkp_EFFEC_STRT_DT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_HASH,lkp_ROW_HASH,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_HASH,lkp_FEATURE_TRANSACTION_ID,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FIRST_BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_TGT_FIRST_BILL_DATE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_HASH,lkp_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_HASH,lkp_DPI_ENVIRONMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_HASH,lkp_SERVICE_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_HASH,lkp_ACCOUNT_SEGMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EVENT_TYPE,Expression,EXP_GENERATE_HASH,lkp_EVENT_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_HASH,lkp_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_HASH,lkp_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Expression,EXP_GENERATE_HASH,DPI_CONTRACT_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Expression,EXP_GENERATE_HASH,PRD_CATLG_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_BY3,Expression,EXP_GENERATE_HASH,CREATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Expression,EXP_GENERATE_HASH,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_DATE3,Expression,EXP_GENERATE_HASH,CREATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,LAST_UPDATED_DATE3,Expression,EXP_GENERATE_HASH,LAST_UPDATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,UPDATED_BY3,Expression,EXP_GENERATE_HASH,UPDATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CA_GENERATED3,Expression,EXP_GENERATE_HASH,CA_GENERATED1,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,IN_DATE3,Expression,EXP_GENERATE_HASH,IN_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Expression,EXP_GENERATE_HASH,USI,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_ID3,Expression,EXP_GENERATE_HASH,GIFT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ETL_CYCLE_ID3,Expression,EXP_GENERATE_HASH,ETL_CYCLE_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,FEATURE_TRANSACTION_ID3,Expression,EXP_GENERATE_HASH,FEATURE_TRANSACTION_ID,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_GL_CODE3,Expression,EXP_GENERATE_HASH,DPI_GL_CODE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,INFINIUM_GL_CODE3,Expression,EXP_GENERATE_HASH,INFINIUM_GL_CODE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TARIFF3,Expression,EXP_GENERATE_HASH,TARIFF,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TAX_DISTRICT3,Expression,EXP_GENERATE_HASH,TAX_DISTRICT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GEO_CODE3,Expression,EXP_GENERATE_HASH,GEO_CODE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,WIRE_CENTER3,Expression,EXP_GENERATE_HASH,WIRE_CENTER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACTIVITY_FLAG3,Expression,EXP_GENERATE_HASH,ACTIVITY_FLAG,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACCOUNT_SEGMENT3,Expression,EXP_GENERATE_HASH,ACCOUNT_SEGMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_SEND_DATE3,Expression,EXP_GENERATE_HASH,GIFT_SEND_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_ENVIRONMENT3,Expression,EXP_GENERATE_HASH,DPI_ENVIRONMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,SERVICE_TYPE3,Expression,EXP_GENERATE_HASH,SERVICE_TYPE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,VALUE3,Expression,EXP_GENERATE_HASH,VALUE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATE_DATE3,Expression,EXP_GENERATE_HASH,CREATE_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,,BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_SRC_FIRST_BILL_DATE,,,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,FEATURE_TRANSACTION_ID3,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,DPI_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,INFINIUM_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,INFINIUM_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,lkp_FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_ID,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACTIVITY_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_SEND_DATE,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TAX_DISTRICT,Router,RTR_INSERT_UPSERT_IGNORE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,VALUE,Router,RTR_INSERT_UPSERT_IGNORE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,lkp_ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EFFEC_STRT_DT,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EFFEC_STRT_DT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_ROW_HASH,Router,RTR_INSERT_UPSERT_IGNORE,o_ROW_HASH,OUTPUT,v_ROW_HASH,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INS_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INS_FLAG,OUTPUT,v_INS_FLAG,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_UPD_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_UPD_FLAG,OUTPUT,v_UPD_FLAG,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,UPDATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,LAST_UPDATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ETL_CYCLE_ID,Router,RTR_INSERT_UPSERT_IGNORE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INPUT_TYPE_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INPUT_TYPE_FLAG,OUTPUT,"DECODE(1,
v_INS_FLAG='I' and ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'C', --ONLY CAPTURE EVENT
v_INS_FLAG='I' and NOT ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'R', --COMBINED EVENT
v_UPD_FLAG='U' ,'U' -- ONLY RELEASE EVENT/ WRITE-OFF/ DISQUALIFIED EVENT
)

",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EVENT_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EVENT_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CA_GENERATED1,Router,RTR_INSERT_UPSERT_IGNORE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_ENVIRONMENT,Router,RTR_INSERT_UPSERT_IGNORE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,SERVICE_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACCOUNT_SEGMENT,Router,RTR_INSERT_UPSERT_IGNORE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATE_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TARIFF,Router,RTR_INSERT_UPSERT_IGNORE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GEO_CODE,Router,RTR_INSERT_UPSERT_IGNORE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,WIRE_CENTER,Router,RTR_INSERT_UPSERT_IGNORE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,IN_DATE,Router,RTR_INSERT_UPSERT_IGNORE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_FIRST_BILL_DATE,Router,RTR_INSERT_UPSERT_IGNORE,FIRST_BILL_DATE,OUTPUT,v_FIRST_BILL_DATE,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,USI,Router,RTR_INSERT_UPSERT_IGNORE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_USI,Router,RTR_INSERT_UPSERT_IGNORE,lkp_USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,USI1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,USI,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_INPUT_TYPE_FLAG1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,o_INPUT_TYPE_FLAG,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_EVENT_TYPE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,lkp_EVENT_TYPE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CA_GENERATED1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,CA_GENERATED1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_ENVIRONMENT1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,SERVICE_TYPE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,SERVICE_TYPE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,IN_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,IN_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FIRST_BILL_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,FIRST_BILL_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ACCOUNT_SEGMENT1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ITEM_SEQUENCE_NUMBER1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_ROW_HASH1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,ROW_HASH,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,CREATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,LAST_UPDATED_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,LAST_UPDATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_BY1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,CREATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,UPDATED_BY1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,UPDATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ETL_CYCLE_ID1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,ETL_CYCLE_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ACTIVITY_FLAG1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_SEND_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,VALUE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,VALU1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATE_DATE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,CREATE_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_CONTRACT_KEY1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,PRD_CATLG_KEY1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_ID1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,GIFT_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FEATURE_TRANSACTION_ID31,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_GL_CODE31,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,INFINIUM_GL_CODE31,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TARIFF1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,TARIFF1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TAX_DISTRICT1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,TAX_DISTRICT1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GEO_CODE1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,GEO_CODE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,WIRE_CENTER1,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,WIRE_CENTER1,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,VALU1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,CREATE_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,o_EFFEC_STRT_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,EFFEC_STRT_DT,OUTPUT,TRUNC(SYSDATE),,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,o_EFFEC_END_DT,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,EFFEC_END_DT,OUTPUT,TRUNC($$EFFEC_END_DT),,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,o_CURRENT_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,CURRENT_FLAG,OUTPUT,$$RECORD_ACTV_FLG,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,CREATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,LAST_UPDATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,CREATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,UPDATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,ETL_CYCLE_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,ROW_HASH,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,TARIFF1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,TAX_DISTRICT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,CA_GENERATED1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,GEO_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,WIRE_CENTER1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,SERVICE_TYPE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,USI,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,EVENT_TYPE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,EVENT_TYPE,OUTPUT,"DECODE(1, 
ACTIVITY_FLAG<>'O' and  not isnull(GIFT_SEND_DATE ) and lkp_EVENT_TYPE='CAPTURE','RELEASE',
ACTIVITY_FLAG='O' and lkp_EVENT_TYPE='CAPTURE','WRITE-OFF'
,'DISQUALIFY')",,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,PROCESS_CYCLE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,PROCESS_CYCLE,OUTPUT,$$ETL_CYCLE_ID,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,GIFT_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,IN_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,2,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT,,FIRST_BILL_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_ACTIVE,FIRST_BILL_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CREATE_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CREATE_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ROW_HASH,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ROW_HASH,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,FEATURE_TRANSACTION_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,INFINIUM_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TARIFF,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TARIFF,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TAX_DISTRICT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TAX_DISTRICT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GEO_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GEO_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,WIRE_CENTER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,WIRE_CENTER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,IN_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,IN_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CONTRACT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,VALUE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,VALUE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_SEND_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,USI,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CA_GENERATED,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_ENVIRONMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,SERVICE_TYPE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,SERVICE_TYPE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACCOUNT_SEGMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CREATE_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,CREATE_DATE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_COMMON_FIELDS,ROW_HASH,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_COMMON_FIELDS,ITEM_SEQUENCE_NUMBER,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_KEY,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,PRD_CATLG_KEY,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_COMMON_FIELDS,FEATURE_TRANSACTION_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_GL_CODE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,INFINIUM_GL_CODE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,CONTRACT_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Expression,EXP_GENERATE_COMMON_FIELDS,ACTIVITY_FLAG,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_SEND_DATE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TARIFF,Expression,EXP_GENERATE_COMMON_FIELDS,TARIFF,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TAX_DISTRICT,Expression,EXP_GENERATE_COMMON_FIELDS,TAX_DISTRICT,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_ENVIRONMENT,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GEO_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,GEO_CODE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_COMMON_FIELDS,USI,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CA_GENERATED,Expression,EXP_GENERATE_COMMON_FIELDS,CA_GENERATED,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_COMMON_FIELDS,SERVICE_TYPE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_COMMON_FIELDS,ACCOUNT_SEGMENT,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,WIRE_CENTER,Expression,EXP_GENERATE_COMMON_FIELDS,WIRE_CENTER,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,IN_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,IN_DATE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,VALUE,Expression,EXP_GENERATE_COMMON_FIELDS,VALUE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CONTRACT_ID3,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,i_CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CREATE_DATE,Router,RTR_CHECK_ERROR,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_LAST_UPDATED_DATE,Router,RTR_CHECK_ERROR,LAST_UPDATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_BY,Router,RTR_CHECK_ERROR,CREATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_UPDATED_BY,Router,RTR_CHECK_ERROR,UPDATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,PRD_CATLG_KEY,Router,RTR_CHECK_ERROR,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_CODE,Router,RTR_CHECK_ERROR,o_ERROR_CODE,OUTPUT,"REG_REPLACE(v_ERROR_CODE,'^\W*','')",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_SOURCE_COLUMN,Router,RTR_CHECK_ERROR,o_SOURCE_COLUMN,OUTPUT,"REG_REPLACE(v_SOURCE_COLUMN,'^\W*','')",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_REQUIRED_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_REQUIRED_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY) OR 
ISNULL(PRD_CATLG_KEY),$$ERR_REPROCES_REQURD_ACTV_FLG,$$ERR_REPROCES_REQURD_FLG)",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_COMPLETE_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_COMPLETE_FLAG,OUTPUT,$$ERR_REPROCES_COMPLT_FLG,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,INFINIUM_GL_CODE,Router,RTR_CHECK_ERROR,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_FLAG,Router,RTR_CHECK_ERROR,o_ERROR_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY)OR 
ISNULL(PRD_CATLG_KEY) OR 
ISNULL(ITEM_SEQUENCE_NUMBER) OR ISNULL(FEATURE_TRANSACTION_ID) OR ISNULL(INFINIUM_GL_CODE) OR INFINIUM_GL_CODE='0000000000000000000000','E','S')",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,FEATURE_TRANSACTION_ID,Router,RTR_CHECK_ERROR,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_GL_CODE,Router,RTR_CHECK_ERROR,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TARIFF,Router,RTR_CHECK_ERROR,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TAX_DISTRICT,Router,RTR_CHECK_ERROR,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GEO_CODE,Router,RTR_CHECK_ERROR,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,WIRE_CENTER,Router,RTR_CHECK_ERROR,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,IN_DATE,Router,RTR_CHECK_ERROR,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,USI,Router,RTR_CHECK_ERROR,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ETL_CYCLE_ID,Router,RTR_CHECK_ERROR,ETL_CYCLE_ID,OUTPUT,$$ETL_CYCLE_ID,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ROW_HASH,Router,RTR_CHECK_ERROR,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_DATE,Router,RTR_CHECK_ERROR,CREATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ITEM_SEQUENCE_NUMBER,Router,RTR_CHECK_ERROR,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_KEY,Router,RTR_CHECK_ERROR,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_ID,Router,RTR_CHECK_ERROR,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CONTRACT_ID,Router,RTR_CHECK_ERROR,CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACTIVITY_FLAG,Router,RTR_CHECK_ERROR,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_SEND_DATE,Router,RTR_CHECK_ERROR,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,VALUE,Router,RTR_CHECK_ERROR,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CA_GENERATED,Router,RTR_CHECK_ERROR,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_ENVIRONMENT,Router,RTR_CHECK_ERROR,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,SERVICE_TYPE,Router,RTR_CHECK_ERROR,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACCOUNT_SEGMENT,Router,RTR_CHECK_ERROR,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_ID,Router,RTR_CHECK_ERROR,DPI_CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_HASH,lkp_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EFFEC_STRT_DT,Expression,EXP_GENERATE_HASH,lkp_EFFEC_STRT_DT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_HASH,lkp_ROW_HASH,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_HASH,lkp_FEATURE_TRANSACTION_ID,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FIRST_BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_TGT_FIRST_BILL_DATE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_HASH,lkp_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_HASH,lkp_DPI_ENVIRONMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_HASH,lkp_SERVICE_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_HASH,lkp_ACCOUNT_SEGMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EVENT_TYPE,Expression,EXP_GENERATE_HASH,lkp_EVENT_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_HASH,lkp_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_HASH,lkp_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Expression,EXP_GENERATE_HASH,DPI_CONTRACT_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Expression,EXP_GENERATE_HASH,PRD_CATLG_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_BY3,Expression,EXP_GENERATE_HASH,CREATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Expression,EXP_GENERATE_HASH,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_DATE3,Expression,EXP_GENERATE_HASH,CREATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,LAST_UPDATED_DATE3,Expression,EXP_GENERATE_HASH,LAST_UPDATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,UPDATED_BY3,Expression,EXP_GENERATE_HASH,UPDATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CA_GENERATED3,Expression,EXP_GENERATE_HASH,CA_GENERATED1,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,IN_DATE3,Expression,EXP_GENERATE_HASH,IN_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Expression,EXP_GENERATE_HASH,USI,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_ID3,Expression,EXP_GENERATE_HASH,GIFT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ETL_CYCLE_ID3,Expression,EXP_GENERATE_HASH,ETL_CYCLE_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,FEATURE_TRANSACTION_ID3,Expression,EXP_GENERATE_HASH,FEATURE_TRANSACTION_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_GL_CODE3,Expression,EXP_GENERATE_HASH,DPI_GL_CODE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,INFINIUM_GL_CODE3,Expression,EXP_GENERATE_HASH,INFINIUM_GL_CODE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TARIFF3,Expression,EXP_GENERATE_HASH,TARIFF,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TAX_DISTRICT3,Expression,EXP_GENERATE_HASH,TAX_DISTRICT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GEO_CODE3,Expression,EXP_GENERATE_HASH,GEO_CODE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,WIRE_CENTER3,Expression,EXP_GENERATE_HASH,WIRE_CENTER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACTIVITY_FLAG3,Expression,EXP_GENERATE_HASH,ACTIVITY_FLAG,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACCOUNT_SEGMENT3,Expression,EXP_GENERATE_HASH,ACCOUNT_SEGMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_SEND_DATE3,Expression,EXP_GENERATE_HASH,GIFT_SEND_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_ENVIRONMENT3,Expression,EXP_GENERATE_HASH,DPI_ENVIRONMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,SERVICE_TYPE3,Expression,EXP_GENERATE_HASH,SERVICE_TYPE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,VALUE3,Expression,EXP_GENERATE_HASH,VALUE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATE_DATE3,Expression,EXP_GENERATE_HASH,CREATE_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,,BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_SRC_FIRST_BILL_DATE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,FEATURE_TRANSACTION_ID3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,DPI_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,INFINIUM_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,INFINIUM_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,lkp_FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_ID,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACTIVITY_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_SEND_DATE,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TAX_DISTRICT,Router,RTR_INSERT_UPSERT_IGNORE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,VALUE,Router,RTR_INSERT_UPSERT_IGNORE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,lkp_ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EFFEC_STRT_DT,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EFFEC_STRT_DT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_ROW_HASH,Router,RTR_INSERT_UPSERT_IGNORE,o_ROW_HASH,OUTPUT,v_ROW_HASH,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INS_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INS_FLAG,OUTPUT,v_INS_FLAG,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_UPD_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_UPD_FLAG,OUTPUT,v_UPD_FLAG,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,UPDATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,LAST_UPDATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ETL_CYCLE_ID,Router,RTR_INSERT_UPSERT_IGNORE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INPUT_TYPE_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INPUT_TYPE_FLAG,OUTPUT,"DECODE(1,
v_INS_FLAG='I' and ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'C', --ONLY CAPTURE EVENT
v_INS_FLAG='I' and NOT ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'R', --COMBINED EVENT
v_UPD_FLAG='U' ,'U' -- ONLY RELEASE EVENT/ WRITE-OFF/ DISQUALIFIED EVENT
)

",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EVENT_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EVENT_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CA_GENERATED1,Router,RTR_INSERT_UPSERT_IGNORE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_ENVIRONMENT,Router,RTR_INSERT_UPSERT_IGNORE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,SERVICE_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACCOUNT_SEGMENT,Router,RTR_INSERT_UPSERT_IGNORE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATE_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TARIFF,Router,RTR_INSERT_UPSERT_IGNORE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GEO_CODE,Router,RTR_INSERT_UPSERT_IGNORE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,WIRE_CENTER,Router,RTR_INSERT_UPSERT_IGNORE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,IN_DATE,Router,RTR_INSERT_UPSERT_IGNORE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_FIRST_BILL_DATE,Router,RTR_INSERT_UPSERT_IGNORE,FIRST_BILL_DATE,OUTPUT,v_FIRST_BILL_DATE,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,USI,Router,RTR_INSERT_UPSERT_IGNORE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_USI,Router,RTR_INSERT_UPSERT_IGNORE,lkp_USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_DPI_CONTRACT_KEY3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_DPI_CONTRACT_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_PRD_CATLG_KEY3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_PRD_CATLG_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_ITEM_SEQUENCE_NUMBER3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_EFFEC_STRT_DT3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_EFFEC_STRT_DT,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_USI3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_USI,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,LAST_UPDATED_DATE3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,LAST_UPDATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,UPDATED_BY3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,UPDATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ETL_CYCLE_ID3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,ETL_CYCLE_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,lkp_FEATURE_TRANSACTION_ID3,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,lkp_FEATURE_TRANSACTION_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='U',TRUE,FALSE)"
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,lkp_DPI_CONTRACT_KEY,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,lkp_DPI_CONTRACT_KEY3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,lkp_PRD_CATLG_KEY,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,lkp_PRD_CATLG_KEY3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,lkp_ITEM_SEQUENCE_NUMBER,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,lkp_ITEM_SEQUENCE_NUMBER3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,lkp_EFFEC_STRT_DT,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,lkp_EFFEC_STRT_DT3,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,LAST_UPDATED_DATE,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,UPDATED_BY,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,ETL_CYCLE_ID,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,o_EFFEC_END_DATE,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,o_EFFEC_END_DATE,OUTPUT,"ADD_TO_DATE(TRUNC(SYSDATE),'DD',-1)",,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,o_CURRENT_FLAG,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,o_CURRENT_FLAG,OUTPUT,$$RECORD_INACTV_FLG,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_UPDATE_S_TXN_CONTRACT_GIFT,,lkp_USI,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,lkp_USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,lkp_DPI_CONTRACT_KEY3,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,DPI_CONTRACT_KEY,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,lkp_PRD_CATLG_KEY3,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,PRD_CATLG_KEY,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,lkp_ITEM_SEQUENCE_NUMBER3,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,ITEM_SEQUENCE_NUMBER,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,lkp_EFFEC_STRT_DT3,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,EFFEC_STRT_DT,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,LAST_UPDATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,LAST_UPDATED_DATE,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,lkp_USI,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,USI,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,UPDATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,UPDATED_BY,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,ETL_CYCLE_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,ETL_CYCLE_ID,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,o_EFFEC_END_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,EFFEC_END_DT,,,,,,
1,3,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Update Strategy,UP_S_TXN_CONTRACT_GIFT_UPD,,o_CURRENT_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_UPDATE_INACTIVE,CURRENT_FLAG,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CREATE_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CREATE_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ROW_HASH,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ROW_HASH,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,FEATURE_TRANSACTION_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,INFINIUM_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TARIFF,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TARIFF,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TAX_DISTRICT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TAX_DISTRICT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GEO_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GEO_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,WIRE_CENTER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,WIRE_CENTER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,IN_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,IN_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CONTRACT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,VALUE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,VALUE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_SEND_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,USI,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CA_GENERATED,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_ENVIRONMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,SERVICE_TYPE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,SERVICE_TYPE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACCOUNT_SEGMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CREATE_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,CREATE_DATE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_COMMON_FIELDS,ROW_HASH,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_ID,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_COMMON_FIELDS,ITEM_SEQUENCE_NUMBER,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_KEY,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,PRD_CATLG_KEY,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_COMMON_FIELDS,FEATURE_TRANSACTION_ID,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_GL_CODE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,INFINIUM_GL_CODE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_ID,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,CONTRACT_ID,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Expression,EXP_GENERATE_COMMON_FIELDS,ACTIVITY_FLAG,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_SEND_DATE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TARIFF,Expression,EXP_GENERATE_COMMON_FIELDS,TARIFF,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TAX_DISTRICT,Expression,EXP_GENERATE_COMMON_FIELDS,TAX_DISTRICT,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_ENVIRONMENT,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GEO_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,GEO_CODE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_COMMON_FIELDS,USI,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CA_GENERATED,Expression,EXP_GENERATE_COMMON_FIELDS,CA_GENERATED,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_COMMON_FIELDS,SERVICE_TYPE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_COMMON_FIELDS,ACCOUNT_SEGMENT,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,WIRE_CENTER,Expression,EXP_GENERATE_COMMON_FIELDS,WIRE_CENTER,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,IN_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,IN_DATE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,VALUE,Expression,EXP_GENERATE_COMMON_FIELDS,VALUE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,i_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CONTRACT_ID3,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,i_CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CREATE_DATE,Router,RTR_CHECK_ERROR,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_LAST_UPDATED_DATE,Router,RTR_CHECK_ERROR,LAST_UPDATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_BY,Router,RTR_CHECK_ERROR,CREATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_UPDATED_BY,Router,RTR_CHECK_ERROR,UPDATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,PRD_CATLG_KEY,Router,RTR_CHECK_ERROR,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_CODE,Router,RTR_CHECK_ERROR,o_ERROR_CODE,OUTPUT,"REG_REPLACE(v_ERROR_CODE,'^\W*','')",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_SOURCE_COLUMN,Router,RTR_CHECK_ERROR,o_SOURCE_COLUMN,OUTPUT,"REG_REPLACE(v_SOURCE_COLUMN,'^\W*','')",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_REQUIRED_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_REQUIRED_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY) OR 
ISNULL(PRD_CATLG_KEY),$$ERR_REPROCES_REQURD_ACTV_FLG,$$ERR_REPROCES_REQURD_FLG)",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_COMPLETE_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_COMPLETE_FLAG,OUTPUT,$$ERR_REPROCES_COMPLT_FLG,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,INFINIUM_GL_CODE,Router,RTR_CHECK_ERROR,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_FLAG,Router,RTR_CHECK_ERROR,o_ERROR_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY)OR 
ISNULL(PRD_CATLG_KEY) OR 
ISNULL(ITEM_SEQUENCE_NUMBER) OR ISNULL(FEATURE_TRANSACTION_ID) OR ISNULL(INFINIUM_GL_CODE) OR INFINIUM_GL_CODE='0000000000000000000000','E','S')",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,FEATURE_TRANSACTION_ID,Router,RTR_CHECK_ERROR,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_GL_CODE,Router,RTR_CHECK_ERROR,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TARIFF,Router,RTR_CHECK_ERROR,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TAX_DISTRICT,Router,RTR_CHECK_ERROR,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GEO_CODE,Router,RTR_CHECK_ERROR,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,WIRE_CENTER,Router,RTR_CHECK_ERROR,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,IN_DATE,Router,RTR_CHECK_ERROR,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,USI,Router,RTR_CHECK_ERROR,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ETL_CYCLE_ID,Router,RTR_CHECK_ERROR,ETL_CYCLE_ID,OUTPUT,$$ETL_CYCLE_ID,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ROW_HASH,Router,RTR_CHECK_ERROR,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_DATE,Router,RTR_CHECK_ERROR,CREATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ITEM_SEQUENCE_NUMBER,Router,RTR_CHECK_ERROR,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_KEY,Router,RTR_CHECK_ERROR,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_ID,Router,RTR_CHECK_ERROR,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CONTRACT_ID,Router,RTR_CHECK_ERROR,CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACTIVITY_FLAG,Router,RTR_CHECK_ERROR,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_SEND_DATE,Router,RTR_CHECK_ERROR,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,VALUE,Router,RTR_CHECK_ERROR,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CA_GENERATED,Router,RTR_CHECK_ERROR,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_ENVIRONMENT,Router,RTR_CHECK_ERROR,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,SERVICE_TYPE,Router,RTR_CHECK_ERROR,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACCOUNT_SEGMENT,Router,RTR_CHECK_ERROR,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_ID,Router,RTR_CHECK_ERROR,DPI_CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_HASH,lkp_ITEM_SEQUENCE_NUMBER,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EFFEC_STRT_DT,Expression,EXP_GENERATE_HASH,lkp_EFFEC_STRT_DT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_HASH,lkp_ROW_HASH,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_HASH,lkp_FEATURE_TRANSACTION_ID,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,FIRST_BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_TGT_FIRST_BILL_DATE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_HASH,lkp_USI,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_HASH,lkp_DPI_ENVIRONMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_HASH,lkp_SERVICE_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_HASH,lkp_ACCOUNT_SEGMENT,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,EVENT_TYPE,Expression,EXP_GENERATE_HASH,lkp_EVENT_TYPE,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_HASH,lkp_DPI_CONTRACT_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,LKP_S_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_HASH,lkp_PRD_CATLG_KEY,,,"SELECT 
T1.EFFEC_STRT_DT as EFFEC_STRT_DT, 
T1.ROW_HASH as ROW_HASH, 
T1.FIRST_BILL_DATE as FIRST_BILL_DATE,
T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY, 
T1.PRD_CATLG_KEY as PRD_CATLG_KEY, 
T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
T1.USI as USI,
T1.EVENT_TYPE as EVENT_TYPE,
T1.DPI_ENVIRONMENT as DPI_ENVIRONMENT,
T1.SERVICE_TYPE as SERVICE_TYPE,
T1.ACCOUNT_SEGMENT as ACCOUNT_SEGMENT
FROM 
$$STG_SCHEMA.S_TXN_CONTRACT_GIFT T1
WHERE CURRENT_FLAG = '$$RECORD_ACTV_FLG'",,DPI_CONTRACT_KEY = i_DPI_CONTRACT_KEY AND PRD_CATLG_KEY = i_PRD_CATLG_KEY AND ITEM_SEQUENCE_NUMBER = i_ITEM_SEQUENCE_NUMBER AND USI = i_USI,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_KEY3,Expression,EXP_GENERATE_HASH,DPI_CONTRACT_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,PRD_CATLG_KEY3,Expression,EXP_GENERATE_HASH,PRD_CATLG_KEY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_BY3,Expression,EXP_GENERATE_HASH,CREATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER3,Expression,EXP_GENERATE_HASH,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_DATE3,Expression,EXP_GENERATE_HASH,CREATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,LAST_UPDATED_DATE3,Expression,EXP_GENERATE_HASH,LAST_UPDATED_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,UPDATED_BY3,Expression,EXP_GENERATE_HASH,UPDATED_BY,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CA_GENERATED3,Expression,EXP_GENERATE_HASH,CA_GENERATED1,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,IN_DATE3,Expression,EXP_GENERATE_HASH,IN_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI3,Expression,EXP_GENERATE_HASH,USI,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_ID3,Expression,EXP_GENERATE_HASH,GIFT_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ETL_CYCLE_ID3,Expression,EXP_GENERATE_HASH,ETL_CYCLE_ID,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,FEATURE_TRANSACTION_ID3,Expression,EXP_GENERATE_HASH,FEATURE_TRANSACTION_ID,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_GL_CODE3,Expression,EXP_GENERATE_HASH,DPI_GL_CODE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,INFINIUM_GL_CODE3,Expression,EXP_GENERATE_HASH,INFINIUM_GL_CODE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TARIFF3,Expression,EXP_GENERATE_HASH,TARIFF,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TAX_DISTRICT3,Expression,EXP_GENERATE_HASH,TAX_DISTRICT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GEO_CODE3,Expression,EXP_GENERATE_HASH,GEO_CODE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,WIRE_CENTER3,Expression,EXP_GENERATE_HASH,WIRE_CENTER,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACTIVITY_FLAG3,Expression,EXP_GENERATE_HASH,ACTIVITY_FLAG,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACCOUNT_SEGMENT3,Expression,EXP_GENERATE_HASH,ACCOUNT_SEGMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_SEND_DATE3,Expression,EXP_GENERATE_HASH,GIFT_SEND_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_ENVIRONMENT3,Expression,EXP_GENERATE_HASH,DPI_ENVIRONMENT,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,SERVICE_TYPE3,Expression,EXP_GENERATE_HASH,SERVICE_TYPE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,VALUE3,Expression,EXP_GENERATE_HASH,VALUE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATE_DATE3,Expression,EXP_GENERATE_HASH,CREATE_DATE,,,,,,"IIF(o_ERROR_FLAG='S',TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Lookup Procedure,sc_LKP_FETCH_FIRST_BILL_DATE,,BILL_DATE,Expression,EXP_GENERATE_HASH,lkp_SRC_FIRST_BILL_DATE,,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,FEATURE_TRANSACTION_ID3,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,DPI_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,INFINIUM_GL_CODE,Router,RTR_INSERT_UPSERT_IGNORE,INFINIUM_GL_CODE3,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_FEATURE_TRANSACTION_ID,Router,RTR_INSERT_UPSERT_IGNORE,lkp_FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_ID,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACTIVITY_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GIFT_SEND_DATE,Router,RTR_INSERT_UPSERT_IGNORE,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TAX_DISTRICT,Router,RTR_INSERT_UPSERT_IGNORE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,VALUE,Router,RTR_INSERT_UPSERT_IGNORE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,lkp_PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_ITEM_SEQUENCE_NUMBER,Router,RTR_INSERT_UPSERT_IGNORE,lkp_ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EFFEC_STRT_DT,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EFFEC_STRT_DT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_ROW_HASH,Router,RTR_INSERT_UPSERT_IGNORE,o_ROW_HASH,OUTPUT,v_ROW_HASH,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INS_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INS_FLAG,OUTPUT,v_INS_FLAG,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_UPD_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_UPD_FLAG,OUTPUT,v_UPD_FLAG,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,UPDATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,LAST_UPDATED_DATE,Router,RTR_INSERT_UPSERT_IGNORE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATED_BY,Router,RTR_INSERT_UPSERT_IGNORE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ETL_CYCLE_ID,Router,RTR_INSERT_UPSERT_IGNORE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_INPUT_TYPE_FLAG,Router,RTR_INSERT_UPSERT_IGNORE,o_INPUT_TYPE_FLAG,OUTPUT,"DECODE(1,
v_INS_FLAG='I' and ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'C', --ONLY CAPTURE EVENT
v_INS_FLAG='I' and NOT ISNULL(GIFT_SEND_DATE) and ACTIVITY_FLAG<>'O', 'R', --COMBINED EVENT
v_UPD_FLAG='U' ,'U' -- ONLY RELEASE EVENT/ WRITE-OFF/ DISQUALIFIED EVENT
)

",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_EVENT_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,lkp_EVENT_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CA_GENERATED1,Router,RTR_INSERT_UPSERT_IGNORE,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_ENVIRONMENT,Router,RTR_INSERT_UPSERT_IGNORE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,SERVICE_TYPE,Router,RTR_INSERT_UPSERT_IGNORE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,ACCOUNT_SEGMENT,Router,RTR_INSERT_UPSERT_IGNORE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,CREATE_DATE,Router,RTR_INSERT_UPSERT_IGNORE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,TARIFF,Router,RTR_INSERT_UPSERT_IGNORE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,GEO_CODE,Router,RTR_INSERT_UPSERT_IGNORE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,WIRE_CENTER,Router,RTR_INSERT_UPSERT_IGNORE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,IN_DATE,Router,RTR_INSERT_UPSERT_IGNORE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,o_FIRST_BILL_DATE,Router,RTR_INSERT_UPSERT_IGNORE,FIRST_BILL_DATE,OUTPUT,v_FIRST_BILL_DATE,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,USI,Router,RTR_INSERT_UPSERT_IGNORE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,lkp_USI,Router,RTR_INSERT_UPSERT_IGNORE,lkp_USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,DPI_CONTRACT_KEY,Router,RTR_INSERT_UPSERT_IGNORE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_HASH,,PRD_CATLG_KEY,Router,RTR_INSERT_UPSERT_IGNORE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_BY4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,CREATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,UPDATED_BY4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,UPDATED_BY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ETL_CYCLE_ID4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,ETL_CYCLE_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FEATURE_TRANSACTION_ID34,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,FEATURE_TRANSACTION_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_GL_CODE34,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,DPI_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_ROW_HASH4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,ROW_HASH,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,INFINIUM_GL_CODE34,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,INFINIUM_GL_CODE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TARIFF4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,TARIFF1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,TAX_DISTRICT4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,TAX_DISTRICT1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CA_GENERATED4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,CA_GENERATED4,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ACCOUNT_SEGMENT4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,ACCOUNT_SEGMENT4,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GEO_CODE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,GEO_CODE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,WIRE_CENTER4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,WIRE_CENTER1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,IN_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,IN_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,FIRST_BILL_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,FIRST_BILL_DATE1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,USI4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,USI,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,o_INPUT_TYPE_FLAG4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,o_INPUT_TYPE_FLAG,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_CONTRACT_KEY4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,DPI_CONTRACT_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_ID4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,GIFT_ID,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,GIFT_SEND_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,GIFT_SEND_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,PRD_CATLG_KEY4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,PRD_CATLG_KEY,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,ITEM_SEQUENCE_NUMBER4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,VALUE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,VALU1,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATE_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,CREATE_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,CREATED_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,CREATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,LAST_UPDATED_DATE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,LAST_UPDATED_DATE,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,DPI_ENVIRONMENT4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,DPI_ENVIRONMENT4,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_INSERT_UPSERT_IGNORE,,SERVICE_TYPE4,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,SERVICE_TYPE4,,,,,,"IIF(o_INPUT_TYPE_FLAG='R' or o_INPUT_TYPE_FLAG='C' ,TRUE,FALSE)"
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,ACTIVITY_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,ACTIVITY_FLAG,OUTPUT,'I',,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,VALU1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,CREATE_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,o_EFFEC_STRT_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,EFFEC_STRT_DT,OUTPUT,TRUNC(IN_DATE1),,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,o_EFFEC_END_DT,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,EFFEC_END_DT,OUTPUT,"iif(o_INPUT_TYPE_FLAG='R',ADD_TO_DATE(trunc(SYSDATE),'DD',-1),TRUNC($$EFFEC_END_DT))",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,o_CURRENT_FLAG,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,CURRENT_FLAG,OUTPUT,"iif(o_INPUT_TYPE_FLAG='R',$$RECORD_INACTV_FLG,$$RECORD_ACTV_FLG)
",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,CREATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,CREATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,LAST_UPDATED_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,LAST_UPDATED_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,CREATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,CREATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,UPDATED_BY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,UPDATED_BY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,ETL_CYCLE_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,ETL_CYCLE_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,ROW_HASH,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,FEATURE_TRANSACTION_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,DPI_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,INFINIUM_GL_CODE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,TARIFF1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,TAX_DISTRICT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,GEO_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,WIRE_CENTER1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,IN_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,FIRST_BILL_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,FIRST_BILL_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,DPI_CONTRACT_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,USI,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,o_GIFT_SEND_DATE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,GIFT_SEND_DATE,OUTPUT,,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,EVENT_TYPE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,EVENT_TYPE,OUTPUT,'CAPTURE',,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,PROCESS_CYCLE,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,PROCESS_CYCLE,OUTPUT,$$ETL_CYCLE_ID,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,PRD_CATLG_KEY,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,ITEM_SEQUENCE_NUMBER,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,GIFT_ID,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,o_CA_GENERATED,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,CA_GENERATED,OUTPUT,"IIF(o_INPUT_TYPE_FLAG = 'R' ,2,CA_GENERATED4)",,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,DPI_ENVIRONMENT4,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,SERVICE_TYPE4,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,4,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_INSERT_S_TXN_CONTRACT_GIFT_CAPTURE,,ACCOUNT_SEGMENT4,Target Definition,SC_S_TXN_CONTRACT_GIFT_INSERT_CAPTURE,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CREATE_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CREATE_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ROW_HASH,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ROW_HASH,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ITEM_SEQUENCE_NUMBER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ITEM_SEQUENCE_NUMBER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,PRD_CATLG_KEY,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,FEATURE_TRANSACTION_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,FEATURE_TRANSACTION_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,INFINIUM_GL_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,INFINIUM_GL_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TARIFF,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TARIFF,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,TAX_DISTRICT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,TAX_DISTRICT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GEO_CODE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GEO_CODE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,WIRE_CENTER,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,WIRE_CENTER,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,IN_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,IN_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,CONTRACT_ID,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,VALUE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,VALUE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACTIVITY_FLAG,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,GIFT_SEND_DATE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,GIFT_SEND_DATE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,USI,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,USI,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,CA_GENERATED,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,DPI_ENVIRONMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_ENVIRONMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,SERVICE_TYPE,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,SERVICE_TYPE,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACCOUNT_SEGMENT,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,ACCOUNT_SEGMENT,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Definition,SC_PS_TXN_CONTRACT_GIFT,RAESTG,ACTIVITY_FLAG,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,DPI_CONTRACT_ID,,,"SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'","SELECT
  T2.GIFT_ID as GIFT_ID,
  T2.CONTRACT_ID as CONTRACT_ID,
  T2.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T2.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T2.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T2.VALUE as VALUE,
  T2.CREATE_DATE as CREATE_DATE,
  T2.ROW_HASH as ROW_HASH,
  T2.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T2.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  CASE WHEN T2.CASE_CHECK = 5 THEN NULL
  ELSE T2.PRD_CATLG_KEY 
  END as PRD_CATLG_KEY,
  T2.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T2.DPI_GL_CODE as DPI_GL_CODE,
  T2.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T2.TARIFF as TARIFF,
  T2.TAX_DISTRICT as TAX_DISTRICT,
  T2.GEO_CODE as GEO_CODE,
  T2.WIRE_CENTER as WIRE_CENTER,
  T2.IN_DATE as IN_DATE,
  T2.USI as USI,
  0 AS CA_GENERATED,
  T2.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T2.SERVICE_TYPE AS SERVICE_TYPE,
  T2.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
  FROM
  (
  SELECT
  T1.GIFT_ID as GIFT_ID,
  T1.CONTRACT_ID as CONTRACT_ID,
  T1.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  T1.ACTIVITY_FLAG as ACTIVITY_FLAG,
  T1.GIFT_SEND_DATE as GIFT_SEND_DATE,
  T1.VALUE as VALUE,
  T1.CREATE_DATE as CREATE_DATE,
  T1.ROW_HASH as ROW_HASH,
  T1.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  T1.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  T1.PRD_CATLG_KEY as PRD_CATLG_KEY,
  T1.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  T1.DPI_GL_CODE as DPI_GL_CODE,
  T1.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  T1.TARIFF as TARIFF,
  T1.TAX_DISTRICT as TAX_DISTRICT,
  T1.GEO_CODE as GEO_CODE,
  T1.WIRE_CENTER as WIRE_CENTER,
  T1.IN_DATE as IN_DATE,
  T1.USI as USI,
  0 as CA_GENERATED,
  T1.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  T1.SERVICE_TYPE AS SERVICE_TYPE,
  T1.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT,
  T1.CASE_CHECK,
  ROW_NUMBER () OVER (PARTITION BY T1.CONTRACT_ID,T1.USI,T1.ITEM_SEQUENCE_NUMBER,T1.ROW_HASH order by T1.CASE_CHECK) as RNK
  FROM
  (
  SELECT
  PCG.GIFT_ID as GIFT_ID,
  PCG.CONTRACT_ID as CONTRACT_ID,
  SCT.DPI_CONTRACT_ID as DPI_CONTRACT_ID,
  PCG.ACTIVITY_FLAG as ACTIVITY_FLAG,
  PCG.GIFT_SEND_DATE as GIFT_SEND_DATE,
  PCG.VALUE as VALUE,
  PCG.CREATE_DATE as CREATE_DATE,
  PCG.ROW_HASH as ROW_HASH,
  PCG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
  SCT.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
  SPROD.PRD_CATLG_KEY AS PRD_CATLG_KEY ,
  CASE 
  WHEN (PCG.TARIFF=TRIM(SPROD.TARIF_CD) AND PCG.SERVICE_TYPE=SPROD.SVC_TYPE) THEN 1
  WHEN (PCG.TARIFF = TRIM(SPROD.TARIF_CD)AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 2
  WHEN (PCG.SERVICE_TYPE =SPROD.SVC_TYPE AND $$TARIFF = SPROD.TARIF_CD) THEN 3
  WHEN ($$TARIFF= SPROD.TARIF_CD AND $$SVC_TYPE = SPROD.SVC_TYPE) THEN 4
  ELSE 5
  END AS CASE_CHECK,
  
  
  PCG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
  PCG.DPI_GL_CODE as DPI_GL_CODE,
  PCG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
  PCG.TARIFF as TARIFF,
  PCG.TAX_DISTRICT as TAX_DISTRICT,
  PCG.GEO_CODE as GEO_CODE,
  PCG.WIRE_CENTER as WIRE_CENTER,
  PCG.IN_DATE as IN_DATE,
  PCG.USI as USI,
  0 as CA_GENERATED,
  PCG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
  PCG.SERVICE_TYPE AS SERVICE_TYPE,
  PCG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
   FROM $$PRE_STG_SCHEMA.PS_TXN_CONTRACT_GIFT PCG
  LEFT OUTER JOIN $$PRE_STG_SCHEMA.PS_TXN_CONTRACT PCT
  ON PCG.CONTRACT_ID = PCT.CONTRACT_ID
AND PCT.ETL_CYCLE_ID = $$ETL_CYCLE_ID
  LEFT OUTER JOIN 
  (SELECT DISTINCT 
  DPI_CONTRACT_KEY, 
  DPI_CONTRACT_ID
  FROM $$PRE_STG_SCHEMA.S_TXN_CONTRACT WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SCT
  ON PCT.DPI_CONTRACT_ID = SCT.DPI_CONTRACT_ID
  LEFT OUTER JOIN   
  (SELECT DISTINCT 
  PRD_CD,
  DPI_ENVRN,
  TARIF_CD,
  SVC_TYPE,
  PRD_CATLG_KEY
  FROM $$STG_SCHEMA.S_MST_PRD_CATLG WHERE CURRENT_FLAG='$$RECORD_ACTV_FLG') SPROD
  
  ON PCG.GIFT_ID = TRIM(SPROD.PRD_CD)
  AND PCG.DPI_ENVIRONMENT = TRIM(SPROD.DPI_ENVRN)
where PCG.ETL_CYCLE_ID=$$ETL_CYCLE_ID

    ) T1 ) T2
  WHERE T2.RNK=1
 
 UNION ALL
 SELECT
 TG.GIFT_ID AS GIFT_ID,
 STC.STD_CONTRACT_ID AS CONTRACT_ID,  
 STC.DPI_CONTRACT_ID AS DPI_CONTRACT_ID, 
 'O' AS ACTIVITY_FLAG,
 TG.GIFT_SEND_DATE as GIFT_SEND_DATE,
 TG.VALUE as VALUE,
 TG.CREATE_DATE as CREATE_DATE,
 TG.ROW_HASH as ROW_HASH,
 TG.ITEM_SEQUENCE_NUMBER as ITEM_SEQUENCE_NUMBER,
 TG.DPI_CONTRACT_KEY as DPI_CONTRACT_KEY,
 TG.PRD_CATLG_KEY as PRD_CATLG_KEY,
 TG.FEATURE_TRANSACTION_ID as FEATURE_TRANSACTION_ID,
 TG.DPI_GL_CODE as DPI_GL_CODE,
 TG.INFINIUM_GL_CODE as INFINIUM_GL_CODE,
 TG.TARIFF as TARIFF,
 TG.TAX_DISTRICT as TAX_DISTRICT,
 TG.GEO_CODE as GEO_CODE,
 TG.WIRE_CENTER as WIRE_CENTER,
 TG.IN_DATE as IN_DATE,
 TG.USI as USI,
 1 AS CA_GENERATED,
 TG.DPI_ENVIRONMENT AS DPI_ENVIRONMENT,
 TG.SERVICE_TYPE AS SERVICE_TYPE,
 TG.ACCOUNT_SEGMENT AS ACCOUNT_SEGMENT
 FROM $$STG_SCHEMA.S_TXN_CONTRACT_GIFT TG
 inner join $$STG_SCHEMA.S_TXN_CONTRACT STC on stc.DPI_CONTRACT_KEY=TG.DPI_CONTRACT_KEY
where TG.current_flag='$$RECORD_ACTV_FLG' and STC.etl_cycle_id=$$ETL_CYCLE_ID
and stc.activity_flag='O' and TG.EVENT_TYPE='CAPTURE'",,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CREATE_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,CREATE_DATE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ROW_HASH,Expression,EXP_GENERATE_COMMON_FIELDS,ROW_HASH,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_ID,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ITEM_SEQUENCE_NUMBER,Expression,EXP_GENERATE_COMMON_FIELDS,ITEM_SEQUENCE_NUMBER,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_CONTRACT_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_CONTRACT_KEY,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,PRD_CATLG_KEY,Expression,EXP_GENERATE_COMMON_FIELDS,PRD_CATLG_KEY,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,FEATURE_TRANSACTION_ID,Expression,EXP_GENERATE_COMMON_FIELDS,FEATURE_TRANSACTION_ID,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_GL_CODE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,INFINIUM_GL_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,INFINIUM_GL_CODE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_ID,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CONTRACT_ID,Expression,EXP_GENERATE_COMMON_FIELDS,CONTRACT_ID,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACTIVITY_FLAG,Expression,EXP_GENERATE_COMMON_FIELDS,ACTIVITY_FLAG,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GIFT_SEND_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,GIFT_SEND_DATE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TARIFF,Expression,EXP_GENERATE_COMMON_FIELDS,TARIFF,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,TAX_DISTRICT,Expression,EXP_GENERATE_COMMON_FIELDS,TAX_DISTRICT,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,DPI_ENVIRONMENT,Expression,EXP_GENERATE_COMMON_FIELDS,DPI_ENVIRONMENT,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,GEO_CODE,Expression,EXP_GENERATE_COMMON_FIELDS,GEO_CODE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,USI,Expression,EXP_GENERATE_COMMON_FIELDS,USI,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,CA_GENERATED,Expression,EXP_GENERATE_COMMON_FIELDS,CA_GENERATED,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,SERVICE_TYPE,Expression,EXP_GENERATE_COMMON_FIELDS,SERVICE_TYPE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,ACCOUNT_SEGMENT,Expression,EXP_GENERATE_COMMON_FIELDS,ACCOUNT_SEGMENT,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,WIRE_CENTER,Expression,EXP_GENERATE_COMMON_FIELDS,WIRE_CENTER,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,IN_DATE,Expression,EXP_GENERATE_COMMON_FIELDS,IN_DATE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Source Qualifier,SQ_SC_PS_TXN_CONTRACT_GIFT,,VALUE,Expression,EXP_GENERATE_COMMON_FIELDS,VALUE,,,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CREATE_DATE,Router,RTR_CHECK_ERROR,CREATE_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_LAST_UPDATED_DATE,Router,RTR_CHECK_ERROR,LAST_UPDATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_BY,Router,RTR_CHECK_ERROR,CREATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_UPDATED_BY,Router,RTR_CHECK_ERROR,UPDATED_BY,OUTPUT,$$ETL_LOAD_USER,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,PRD_CATLG_KEY,Router,RTR_CHECK_ERROR,PRD_CATLG_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_CODE,Router,RTR_CHECK_ERROR,o_ERROR_CODE,OUTPUT,"REG_REPLACE(v_ERROR_CODE,'^\W*','')",,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_SOURCE_COLUMN,Router,RTR_CHECK_ERROR,o_SOURCE_COLUMN,OUTPUT,"REG_REPLACE(v_SOURCE_COLUMN,'^\W*','')",,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_REQUIRED_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_REQUIRED_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY) OR 
ISNULL(PRD_CATLG_KEY),$$ERR_REPROCES_REQURD_ACTV_FLG,$$ERR_REPROCES_REQURD_FLG)",,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_REPROCESSING_COMPLETE_FLAG,Router,RTR_CHECK_ERROR,o_REPROCESSING_COMPLETE_FLAG,OUTPUT,$$ERR_REPROCES_COMPLT_FLG,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,INFINIUM_GL_CODE,Router,RTR_CHECK_ERROR,INFINIUM_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ERROR_FLAG,Router,RTR_CHECK_ERROR,o_ERROR_FLAG,OUTPUT,"IIF(ISNULL(DPI_CONTRACT_KEY)OR 
ISNULL(PRD_CATLG_KEY) OR 
ISNULL(ITEM_SEQUENCE_NUMBER) OR ISNULL(FEATURE_TRANSACTION_ID) OR ISNULL(INFINIUM_GL_CODE) OR INFINIUM_GL_CODE='0000000000000000000000','E','S')",,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,FEATURE_TRANSACTION_ID,Router,RTR_CHECK_ERROR,FEATURE_TRANSACTION_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_GL_CODE,Router,RTR_CHECK_ERROR,DPI_GL_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TARIFF,Router,RTR_CHECK_ERROR,TARIFF,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,TAX_DISTRICT,Router,RTR_CHECK_ERROR,TAX_DISTRICT,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GEO_CODE,Router,RTR_CHECK_ERROR,GEO_CODE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,WIRE_CENTER,Router,RTR_CHECK_ERROR,WIRE_CENTER,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,IN_DATE,Router,RTR_CHECK_ERROR,IN_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,USI,Router,RTR_CHECK_ERROR,USI,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_ETL_CYCLE_ID,Router,RTR_CHECK_ERROR,ETL_CYCLE_ID,OUTPUT,$$ETL_CYCLE_ID,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ROW_HASH,Router,RTR_CHECK_ERROR,ROW_HASH,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,o_CREATED_DATE,Router,RTR_CHECK_ERROR,CREATED_DATE,OUTPUT,SESSSTARTTIME,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ITEM_SEQUENCE_NUMBER,Router,RTR_CHECK_ERROR,ITEM_SEQUENCE_NUMBER,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_KEY,Router,RTR_CHECK_ERROR,DPI_CONTRACT_KEY,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_ID,Router,RTR_CHECK_ERROR,GIFT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CONTRACT_ID,Router,RTR_CHECK_ERROR,CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACTIVITY_FLAG,Router,RTR_CHECK_ERROR,ACTIVITY_FLAG,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,GIFT_SEND_DATE,Router,RTR_CHECK_ERROR,GIFT_SEND_DATE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,VALUE,Router,RTR_CHECK_ERROR,VALUE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,CA_GENERATED,Router,RTR_CHECK_ERROR,CA_GENERATED,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_ENVIRONMENT,Router,RTR_CHECK_ERROR,DPI_ENVIRONMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,SERVICE_TYPE,Router,RTR_CHECK_ERROR,SERVICE_TYPE,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,ACCOUNT_SEGMENT,Router,RTR_CHECK_ERROR,ACCOUNT_SEGMENT,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Expression,EXP_GENERATE_COMMON_FIELDS,,DPI_CONTRACT_ID,Router,RTR_CHECK_ERROR,DPI_CONTRACT_ID,INPUT/OUTPUT,DIRECT MAP,,,,
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,IN_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,IN_DATE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_BY1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,CREATED_BY,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,UPDATED_BY1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,UPDATED_BY,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ETL_CYCLE_ID1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ETL_CYCLE_ID,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ROW_HASH1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ROW_HASH,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATED_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,CREATED_DATE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ITEM_SEQUENCE_NUMBER1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ITEM_SEQUENCE_NUMBER,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,LAST_UPDATED_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,LAST_UPDATED_DATE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_SEND_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,GIFT_SEND_DATE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,VALUE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,VALUE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CREATE_DATE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,CREATE_DATE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_ENVIRONMENT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,DPI_ENVIRONMENT,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,SERVICE_TYPE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,SERVICE_TYPE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACCOUNT_SEGMENT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ACCOUNT_SEGMENT,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_CONTRACT_ID1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,DPI_CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,o_REPROCESSING_COMPLETE_FLAG1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,REPROCESSING_COMPLETE_FLAG,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,FEATURE_TRANSACTION_ID1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,FEATURE_TRANSACTION_ID,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TARIFF1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,TARIFF,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,TAX_DISTRICT1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,TAX_DISTRICT,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,o_REPROCESSING_REQUIRED_FLAG1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,REPROCESSING_REQUIRED_FLAG,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,USI1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,USI,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,DPI_GL_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,DPI_GL_CODE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,INFINIUM_GL_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,INFINIUM_GL_CODE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GIFT_ID1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,GIFT_ID,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,ACTIVITY_FLAG1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ACTIVITY_FLAG,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,CONTRACT_ID1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,CONTRACT_ID,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,GEO_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,GEO_CODE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,WIRE_CENTER1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,WIRE_CENTER,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,o_ERROR_CODE1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,ERROR_CODE,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
1,5,m_PS_TO_STG_S_TXN_CONTRACT_GIFT_LOAD,Router,RTR_CHECK_ERROR,,o_SOURCE_COLUMN1,Target Definition,SC_S_TXN_CONTRACT_GIFT_ERROR,SOURCE_COLUMN,,,,,,"IIF(o_ERROR_FLAG='E',TRUE,FALSE)"
